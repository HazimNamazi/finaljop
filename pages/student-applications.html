<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“„ Ø·Ù„Ø¨Ø§ØªÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      background:#eef1f5;
      font-family:'Tajawal', sans-serif;
      margin:0;
      padding:20px;
    }

    h2 {
      color:#007bff;
      margin-bottom:20px;
    }

    .back-btn {
      display:inline-block;
      margin-bottom:20px;
      background:#007bff;
      color:white;
      padding:10px 18px;
      border-radius:8px;
      font-size:15px;
      text-decoration:none;
      font-weight:bold;
      transition:0.3s;
    }

    .back-btn:hover {
      background:#005ecb;
    }

    .card {
      background:white;
      padding:20px;
      margin-bottom:15px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    .title {
      font-size:18px;
      font-weight:700;
      color:#007bff;
      margin-bottom:5px;
    }

    .status {
      font-weight:bold;
      margin-top:10px;
    }

    .badge {
      display:inline-block;
      padding:4px 10px;
      border-radius:20px;
      font-size:13px;
      margin-top:6px;
    }

    .accepted { background:#e6f9ec; color:#28a745; }
    .rejected { background:#fdecea; color:#dc3545; }
    .pending  { background:#fff4e5; color:#e69500; }

    .interview-box {
      margin-top:10px;
      padding:10px;
      border-radius:8px;
      background:#e8f4ff;
      border:1px solid #b6daff;
      font-weight:600;
    }

    .msg-box {
      background:#e9f7ff;
      padding:12px;
      border-left:4px solid #007bff;
      border-radius:10px;
      margin-top:12px;
      font-size:15px;
      line-height:1.7;
    }

    .msg-time {
      font-size:13px;
      color:#555;
      margin-top:4px;
    }

    a {
      color:#007bff;
      font-weight:600;
      text-decoration:none;
    }

  </style>
</head>

<body>

<a href="jobs.html" class="back-btn">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</a>

<h2>ğŸ“„ Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
<div id="list"></div>

<script>

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || user.user_type !== "job_seeker") {
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨.");
    location.href = "login.html";
  }

  async function loadApplications() {
    const res = await fetch(`/.netlify/functions/get-student-applications?student_id=${user.id}`);
    const data = await res.json();

    const container = document.getElementById("list");
    container.innerHTML = "";

    if (!data.applications || !data.applications.length) {
      container.innerHTML = "<p>â— Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
      return;
    }

    data.applications.forEach(app => {

      const status = (app.status || "").toLowerCase();
      let badgeClass = "pending";
      let readableStatus = "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";

      if (status === "accepted" || status === "Ù…Ù‚Ø¨ÙˆÙ„") {
        badgeClass = "accepted";
        readableStatus = "Ù…Ù‚Ø¨ÙˆÙ„";
      }
      else if (status === "rejected" || status === "Ù…Ø±ÙÙˆØ¶") {
        badgeClass = "rejected";
        readableStatus = "Ù…Ø±ÙÙˆØ¶";
      }
      else if (status === "interview" || status === "Ù…Ù‚Ø§Ø¨Ù„Ø©") {
        badgeClass = "pending";
        readableStatus = "Ù…Ù‚Ø§Ø¨Ù„Ø©";
      }

      const interviewBox = app.interview_date
        ? `
          <div class="interview-box">
            ğŸ“… Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©:<br>
            ${new Date(app.interview_date).toLocaleString("ar-SA")}
          </div>
        `
        : "";

      const messageBox = app.message_from_company
        ? `
          <div class="msg-box">
            ğŸ’¬ <strong>Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©:</strong><br>
            ${app.message_from_company}
            <div class="msg-time">
              ğŸ•“ Ø¨ØªØ§Ø±ÙŠØ®: ${
                app.message_date
                  ? new Date(app.message_date).toLocaleString("ar-SA")
                  : "â€”"
              }
            </div>
          </div>
        `
        : "";

      container.innerHTML += `
        <div class="card">
          <div class="title">ğŸ’¼ ${app.job_title} â€“ ${app.company_name}</div>

          <div>ğŸ“ ${app.location} | ğŸ’° ${app.salary_range || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>

          <div>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:
            ${app.created_at ? app.created_at.split("T")[0] : ""}
          </div>

          <div class="status">
            ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©:
            <span class="badge ${badgeClass}">${readableStatus}</span>
          </div>

          ${interviewBox}
          ${messageBox}

          ${
            app.cv_url
              ? `<div style="margin-top:10px;">
                  <a href="${app.cv_url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</a>
                </div>`
              : ""
          }
        </div>
      `;
    });
  }

  loadApplications();
</script>

</body>
</html>
