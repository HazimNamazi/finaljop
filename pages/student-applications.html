<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ“„ Ø·Ù„Ø¨Ø§ØªÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<style>
  body {
    background:#eef1f5;
    font-family:'Tajawal', sans-serif;
    margin:0;
    padding:20px;
  }

  h2 {
    color:#007bff;
    margin-bottom:20px;
  }

  .card {
    background:white;
    padding:20px;
    margin-bottom:15px;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
  }

  .title {
    font-size:18px;
    font-weight:700;
    color:#007bff;
    margin-bottom:5px;
  }

  .status {
    font-weight:bold;
    margin-top:10px;
  }

  .badge {
    display:inline-block;
    padding:4px 10px;
    border-radius:20px;
    font-size:13px;
    margin-top:6px;
  }

  .accepted {
    color:green;
  }
  .rejected {
    color:red;
  }
  .pending {
    color:orange;
  }

  .badge-accepted {
    background:#e6f9ec;
    color:#1e7e34;
  }
  .badge-rejected {
    background:#fdecea;
    color:#c82333;
  }
  .badge-pending {
    background:#fff4e5;
    color:#e69500;
  }

  .interview-box {
    margin-top:10px;
    padding:10px;
    border-radius:8px;
    background:#e8f4ff;
    border:1px solid #b6daff;
    font-weight:600;
  }

  a {
    color:#007bff;
    font-weight:600;
    text-decoration:none;
  }
</style>
</head>

<body>

<h2>ğŸ“„ Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
<div id="list"></div>

<script>
// ===============================
// ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
// ===============================
const user = JSON.parse(localStorage.getItem("user"));
if (!user || user.user_type !== "student") {
  alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨.");
  location.href = "login.html";
}

// ===============================
// ğŸ“Œ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
// ===============================
async function loadApplications() {
  const res = await fetch(`/.netlify/functions/get-student-applications?student_id=${user.id}`);
  const data = await res.json();

  const container = document.getElementById("list");
  container.innerHTML = "";

  if (!data.applications || !data.applications.length) {
    container.innerHTML = "<p>â— Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
    return;
  }

  let hasNewAccepted = false;
  let hasNewInterview = false;

  // Ù†Ù‚Ø±Ø£ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ØªÙ… ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø§ Ù…Ù† localStorage
  const notifiedAccepted = JSON.parse(localStorage.getItem("notifiedAcceptedApps") || "[]");
  const notifiedInterview = JSON.parse(localStorage.getItem("notifiedInterviewApps") || "[]");

  data.applications.forEach(app => {
    // Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ù…ØªÙˆØ§ÙÙ‚Ø© (Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
    const status = (app.status || "").toLowerCase();
    let readableStatus = app.status || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    let statusClass = "pending";
    let badgeClass = "badge-pending";

    if (status === "accepted" || status === "Ù…Ù‚Ø¨ÙˆÙ„") {
      statusClass = "accepted";
      badgeClass = "badge-accepted";
      readableStatus = "Ù…Ù‚Ø¨ÙˆÙ„";

      if (!notifiedAccepted.includes(app.id)) {
        hasNewAccepted = true;
        notifiedAccepted.push(app.id);
      }
    } else if (status === "rejected" || status === "Ù…Ø±ÙÙˆØ¶") {
      statusClass = "rejected";
      badgeClass = "badge-rejected";
      readableStatus = "Ù…Ø±ÙÙˆØ¶";
    } else {
      readableStatus = "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
    }

    // ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‚Ø§Ø¨Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
    const hasInterviewDate = !!app.interview_date;
    if (hasInterviewDate && !notifiedInterview.includes(app.id)) {
      hasNewInterview = true;
      notifiedInterview.push(app.id);
    }

    container.innerHTML += `
      <div class="card">
        <div class="title">ğŸ’¼ ${app.job_title} â€“ ${app.company_name}</div>
        <div>ğŸ“ ${app.location} | ğŸ’° ${app.salary_range || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
        <div>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: ${app.created_at ? app.created_at.split("T")[0] : ""}</div>

        <div class="status ${statusClass}">
          ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©:
          <span class="badge ${badgeClass}">${readableStatus}</span>
        </div>

        ${hasInterviewDate ? `
          <div class="interview-box">
            ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©:<br>
            ${app.interview_date}
          </div>
        ` : ""}

        ${app.cv_link || app.cv_url ? `
          <div style="margin-top:10px;">
            <a href="${app.cv_link || app.cv_url}" target="_blank">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</a>
          </div>
        ` : ""}
      </div>
    `;
  });

  // Ø­ÙØ¸ Ù…Ø§ ØªÙ… ØªÙ†Ø¨ÙŠÙ‡Ù‡ Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙƒØ±Ø± ÙƒÙ„ Ù…Ø±Ø©
  localStorage.setItem("notifiedAcceptedApps", JSON.stringify(notifiedAccepted));
  localStorage.setItem("notifiedInterviewApps", JSON.stringify(notifiedInterview));

  // ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† ÙÙŠÙ‡ Ø¬Ø¯ÙŠØ¯
  if (hasNewAccepted && hasNewInterview) {
    alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¨Ø¹Ø¶ Ø·Ù„Ø¨Ø§ØªÙƒ ÙˆØªØ­Ø¯ÙŠØ¯ Ù…Ù‚Ø§Ø¨Ù„Ø§Øª Ø´Ø®ØµÙŠØ©. ØªÙÙ‚Ø¯ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§ØªÙƒ.");
  } else if (hasNewAccepted) {
    alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø£Ø­Ø¯ Ø·Ù„Ø¨Ø§ØªÙƒ. ØªÙÙ‚Ø¯ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§ØªÙƒ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
  } else if (hasNewInterview) {
    alert("ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ù…Ù‚Ø§Ø¨Ù„Ø© Ø´Ø®ØµÙŠØ© Ù„Ø¥Ø­Ø¯Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙŠ ØªÙ‚Ø¯Ù…Øª Ù„Ù‡Ø§. ØªÙÙ‚Ø¯ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§ØªÙƒ.");
  }
}

loadApplications();
</script>

</body>
</html>
