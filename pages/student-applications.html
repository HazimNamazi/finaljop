<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“„ Ø·Ù„Ø¨Ø§ØªÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      background:#eef1f5;
      font-family:'Tajawal', sans-serif;
      margin:0;
      padding:20px;
    }

    h2 {
      color:#007bff;
      margin-bottom:20px;
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
    .card {
      background:white;
      padding:20px;
      margin-bottom:15px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    .title {
      font-size:18px;
      font-weight:700;
      color:#007bff;
      margin-bottom:5px;
    }

    .status {
      font-weight:bold;
      margin-top:10px;
    }

    .badge {
      display:inline-block;
      padding:4px 10px;
      border-radius:20px;
      font-size:13px;
      margin-top:6px;
    }

    .accepted { color:green; }
    .rejected { color:red; }
    .pending { color:orange; }

    .badge-accepted {
      background:#e6f9ec;
      color:#1e7e34;
    }
    .badge-rejected {
      background:#fdecea;
      color:#c82333;
    }
    .badge-pending {
      background:#fff4e5;
      color:#e69500;
    }

    .interview-box {
      margin-top:10px;
      padding:10px;
      border-radius:8px;
      background:#e8f4ff;
      border:1px solid #b6daff;
      font-weight:600;
    }

    a {
      color:#007bff;
      font-weight:600;
      text-decoration:none;
    }

    /* ÙˆØ±Ø´ Ø§Ù„Ø¹Ù…Ù„ */
    .workshop-card {
      background:white;
      padding:20px;
      margin-bottom:15px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    .workshop-title {
      font-size:18px;
      font-weight:700;
      color:#28a745;
      margin-bottom:5px;
    }

    .attended-tag {
      display:inline-block;
      padding:4px 10px;
      background:#e6f9ec;
      color:#1e7e34;
      border-radius:20px;
      font-size:13px;
      font-weight:700;
    }

    button {
      padding:8px 14px;
      background:#007bff;
      color:white;
      border:none;
      border-radius:6px;
      cursor:pointer;
      margin-top:10px;
    }

    button:hover {
      background:#0056b3;
    }
  </style>
</head>

<body>

<!-- ------------------------------ -->
<!--        Ù‚Ø³Ù… Ø§Ù„ÙˆØ±Ø´               -->
<!-- ------------------------------ -->
<h2>ğŸ“˜ ÙˆØ±Ø´ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
<div id="workshops"></div>

<hr style="margin:35px 0;">

<!-- ------------------------------ -->
<!--         Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª            -->
<!-- ------------------------------ -->
<h2>ğŸ“„ Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
<div id="list"></div>

<script>
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || user.user_type !== "job_seeker") {
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨.");
    location.href = "login.html";
  }

  // =============================================
  //         ØªØ­Ù…ÙŠÙ„ ÙˆØ±Ø´ Ø§Ù„Ø¹Ù…Ù„
  // =============================================
  async function loadWorkshops() {
    const res = await fetch("/.netlify/functions/get-workshops");
    const workshops = await res.json();

    const wContainer = document.getElementById("workshops");
    wContainer.innerHTML = "";

    if (!workshops.length) {
      wContainer.innerHTML = "<p>â— Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ±Ø´ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
      return;
    }

    for (let w of workshops) {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
      const attRes = await fetch(
        `/.netlify/functions/check-workshop-attendance?student_id=${user.id}&workshop_id=${w.id}`
      );
      const attended = (await attRes.json()).attended;

      wContainer.innerHTML += `
        <div class="workshop-card">
          <div class="workshop-title">ğŸ“˜ ${w.title}</div>
          <div>ğŸ“… ${w.date} â€“ â° ${w.time}</div>
          <div>ğŸ“ ${w.location || "Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†"}</div>

          ${w.link ? `<a href="${w.link}" target="_blank">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ±Ø´Ø©</a>` : ""}

          <div style="margin-top:10px;">
            ${
              attended
                ? `<span class="attended-tag">âœ”ï¸ Ø­Ø¶Ø±Øª Ø§Ù„ÙˆØ±Ø´Ø©</span>`
                : `<button onclick="attendWorkshop(${w.id})">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>`
            }
          </div>
        </div>
      `;
    }
  }

  async function attendWorkshop(workshop_id) {
    await fetch("/.netlify/functions/attend-workshop", {
      method: "POST",
      body: JSON.stringify({
        student_id: user.id,
        workshop_id
      })
    });

    alert("âœ”ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­");
    loadWorkshops();
  }

  // =============================================
  //        ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù
  // =============================================
  async function loadApplications() {
    const res = await fetch(
      `/.netlify/functions/get-student-applications?student_id=${user.id}`
    );
    const data = await res.json();

    const container = document.getElementById("list");
    container.innerHTML = "";

    if (!data.applications || !data.applications.length) {
      container.innerHTML = "<p>â— Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
      return;
    }

    data.applications.forEach(app => {
      const status = (app.status || "").toLowerCase();
      let readableStatus = app.status || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      let badgeClass = "badge-pending";

      if (status === "accepted" || status === "Ù…Ù‚Ø¨ÙˆÙ„") {
        badgeClass = "badge-accepted";
        readableStatus = "Ù…Ù‚Ø¨ÙˆÙ„";
      } else if (status === "rejected" || status === "Ù…Ø±ÙÙˆØ¶") {
        badgeClass = "badge-rejected";
        readableStatus = "Ù…Ø±ÙÙˆØ¶";
      } else if (status === "interview" || status === "Ù…Ù‚Ø§Ø¨Ù„Ø©") {
        badgeClass = "badge-pending";
        readableStatus = "Ù…Ù‚Ø§Ø¨Ù„Ø©";
      } else {
        readableStatus = "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
      }

      const hasInterviewDate = !!app.interview_date;

      container.innerHTML += `
        <div class="card">
          <div class="title">ğŸ’¼ ${app.job_title} â€“ ${app.company_name}</div>
          <div>ğŸ“ ${app.location} | ğŸ’° ${app.salary_range || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
          <div>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: ${app.created_at ? app.created_at.split("T")[0] : ""}</div>

          <div class="status">
            ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©:
            <span class="badge ${badgeClass}">${readableStatus}</span>
          </div>

          ${
            hasInterviewDate
              ? `
            <div class="interview-box">
              ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©:<br>
              ${app.interview_date}
            </div>
          `
              : ""
          }

          ${
            app.cv_url
              ? `
            <div style="margin-top:10px;">
              <a href="view-cv.html?file=${encodeURIComponent(app.cv_url)}" target="_blank">
                ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©
              </a>
            </div>
          `
              : ""
          }
        </div>
      `;
    });
  }

  // ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
  loadWorkshops();
  loadApplications();
</script>

</body>
</html>
