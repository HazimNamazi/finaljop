<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¢ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø±ÙƒØ§Øª</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Tajawal', sans-serif;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: #fff;
    margin: 0;
    min-height: 100vh;
    padding: 40px 10px;
    display: flex;
    justify-content: center;
  }

  .dashboard {
    background: rgba(255,255,255,0.08);
    padding: 30px;
    border-radius: 20px;
    width: 100%;
    max-width: 900px;
    backdrop-filter: blur(10px);
    box-shadow: 0 5px 25px rgba(0,0,0,0.2);
  }

  h1,h2 { text-align: center; }
  h2 { margin-top: 40px; }

  .btn {
    background: #007bff;
    padding: 10px 20px;
    color: white;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }

  input, textarea {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 10px;
    border: none;
    background: rgba(255,255,255,0.15);
    color: white;
  }

  .card {
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 12px;
    margin: 10px 0;
  }

  button.small-btn {
    padding: 6px 12px;
    margin: 5px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
  }

  .accept { background: #28a745; }
  .reject { background: #dc3545; }
  .schedule { background: #ffbf00; }
</style>
</head>

<body>

<div class="dashboard">
  <h1>ğŸ¢ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø±ÙƒØ§Øª</h1>
  <h2 id="welcome"></h2>

  <button class="btn" onclick="toggleForm()">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ©</button>

  <div id="jobForm" style="display:none;">
    <h2>Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <input type="text" id="title" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
    <textarea id="desc" placeholder="Ø§Ù„ÙˆØµÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ"></textarea>
    <input type="text" id="location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
    <input type="text" id="salary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨">

    <button class="btn" onclick="addJob()">Ù†Ø´Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©</button>
  </div>

  <h2>ğŸ“‹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h2>
  <div id="jobsList"></div>

  <h2>ğŸ“¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</h2>
  <div id="appsList"></div>
</div>

<script>
  const user = JSON.parse(localStorage.getItem("user"));

  if (!user || user.user_type !== "company") {
    alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø±ÙƒØ©.");
    window.location.href = "login.html";
  }

  document.getElementById("welcome").innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ " + user.full_name;

  function toggleForm() {
    const form = document.getElementById("jobForm");
    form.style.display = (form.style.display === "none") ? "block" : "none";
  }

  // ============================
  //  Ù†Ø´Ø± ÙˆØ¸ÙŠÙØ©
  // ============================
  async function addJob() {
    const job_title = document.getElementById("title").value;
    const job_description = document.getElementById("desc").value;
    const location = document.getElementById("location").value;
    const salary = document.getElementById("salary").value;

    const res = await fetch("/.netlify/functions/add-job", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        company_id: user.id,
        company_name: user.full_name,
        job_title,
        job_description,
        location,
        salary_range: salary,
        job_type: "Full-time"
      })
    });

    const data = await res.json();

    if (data.success) {
      alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©!");
      loadJobs();
    } else alert("Ø®Ø·Ø£: " + data.message);
  }

  // ============================
  //  ØªØ­Ù…ÙŠÙ„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø´Ø±ÙƒØ©
  // ============================
  async function loadJobs() {
    const res = await fetch(`/.netlify/functions/get-company-jobs?company_id=${user.id}`);
    const jobs = await res.json();

    document.getElementById("jobsList").innerHTML = jobs.map(j => `
      <div class="card">
        <h3>${j.job_title}</h3>
        <p>${j.job_description}</p>
        <p>ğŸ“ ${j.location} â€” ğŸ’° ${j.salary_range}</p>
      </div>
    `).join("");
  }

  // ============================
  //  ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
  // ============================
  async function loadApps() {
    const res = await fetch(`/.netlify/functions/get-company-applications?company_id=${user.id}`);
    const apps = await res.json();

    document.getElementById("appsList").innerHTML = apps.map(a => `
      <div class="card">
        <h3>${a.applicant_name}</h3>
        <p>Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${a.job_title}</p>
        <a href="${a.cv_link}" target="_blank">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</a>
        <p>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${a.status}</b></p>
        <button class="small-btn accept" onclick="updateStatus(${a.id}, 'Ù…Ù‚Ø¨ÙˆÙ„')">Ù‚Ø¨ÙˆÙ„</button>
        <button class="small-btn reject" onclick="updateStatus(${a.id}, 'Ù…Ø±ÙÙˆØ¶')">Ø±ÙØ¶</button>
        <button class="small-btn schedule" onclick="scheduleInterview(${a.id})">ğŸ“… Ù…Ù‚Ø§Ø¨Ù„Ø©</button>
      </div>
    `).join("");
  }

  async function updateStatus(id, status) {
    await fetch("/.netlify/functions/update-application-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, status })
    });
    loadApps();
  }

  async function scheduleInterview(id) {
    const date = prompt("ğŸ•“ Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© (Ù…Ø«Ø§Ù„: 2025-01-20 4PM):");
    if (!date) return;

    await fetch("/.netlify/functions/update-application-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id,
        status: "Ù…Ù‚Ø§Ø¨Ù„Ø©",
        interview_date: date
      })
    });

    alert("ğŸ“… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©!");
    loadApps();
  }

  loadJobs();
  loadApps();
</script>

</body>
</html>
