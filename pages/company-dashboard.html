<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      background: #eef1f5;
      font-family: 'Tajawal';
      margin: 0;
      padding: 0;
    }

    /* ğŸ”µ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    header {
      background: #007bff;
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
    }

    .logout-btn {
      background: #dc3545;
      padding: 8px 15px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      border: none;
      font-size: 14px;
    }

    .main-container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h2 { color:#007bff; margin-top:0; }

    .card {
      background:#fff;
      padding:20px;
      border-radius:10px;
      margin-bottom:15px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      text-align:right;
    }

    .status { font-weight:bold; margin-top:10px; }

    button {
      padding: 10px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:15px;
      margin-left:7px;
      transition:0.3s;
    }

    .btn-accept { background:#28a745; color:white; }
    .btn-reject { background:#dc3545; color:white; }
    .btn-interview { background:#007bff; color:white; }
    .btn-delete { background:#ff4444; color:white; }

    button:hover { transform:scale(1.05); }

    .modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
    }

    .modal-content {
      background:white;
      padding:25px;
      border-radius:12px;
      width:350px;
      text-align:center;
    }

    input[type="datetime-local"] {
      width:100%;
      padding:10px;
      border-radius:8px;
      margin-bottom:15px;
      border:1px solid #ccc;
    }
  </style>
</head>

<body>

<!-- ğŸ”µ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<header>
  <div id="companyName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</div>
  <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</header>

<div class="main-container">

  <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  <div class="container">
    <h2>ğŸ“¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</h2>
    <div id="applicationsList"></div>
  </div>

  <!-- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© -->
  <div class="container">
    <h2>ğŸ’¼ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙŠ Ù‚Ù…Øª Ø¨Ø±ÙØ¹Ù‡Ø§</h2>
    <div id="companyJobsList"></div>
  </div>

</div>

<!-- ğŸ“… Ù†Ø§ÙØ°Ø© ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© -->
<div class="modal" id="interviewModal">
  <div class="modal-content">
    <h3>ğŸ•“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©</h3>

    <input type="datetime-local" id="interviewDate">
    <button class="btn-interview" id="saveInterviewBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
    <button onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script>
  let selectedApplication = null;

  // ğŸ“Œ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
  const user = JSON.parse(localStorage.getItem("user"));

  if (!user || user.user_type !== "company") {
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø±ÙƒØ©.");
    location.href = "login.html";
  }

  document.getElementById("companyName").innerText = user.full_name || user.username;

  // ğŸ”´ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
  function logout() {
    localStorage.removeItem("user");
    location.href = "login.html";
  }

  // ğŸ“Œ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  async function loadApplications() {
    const res = await fetch(`/.netlify/functions/get-company-applications?company_id=${user.id}`);
    const apps = await res.json();

    const list = document.getElementById("applicationsList");
    list.innerHTML = "";

    if (!apps.length) {
      list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
      return;
    }

    apps.forEach(app => {
      list.innerHTML += `
        <div class="card">
          <div><strong>${app.applicant_name}</strong> Ù‚Ø¯Ù… Ø¹Ù„Ù‰ ÙˆØ¸ÙŠÙØ©: ${app.job_title}</div>
          <div>ğŸ“§ ${app.email}</div>
          <div class="status">Ø§Ù„Ø­Ø§Ù„Ø©: ${app.status}</div>
          ${app.cv_link ? `<a href="${app.cv_link}" target="_blank">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</a>` : ""}
          <br><br>
          <button class="btn-accept" onclick="updateStatus(${app.id}, 'Ù…Ù‚Ø¨ÙˆÙ„')">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn-reject" onclick="updateStatus(${app.id}, 'Ù…Ø±ÙÙˆØ¶')">Ø±ÙØ¶</button>
          <button class="btn-interview" onclick="openModal(${app.id})">ğŸ“… Ù…Ù‚Ø§Ø¨Ù„Ø©</button>
        </div>
      `;
    });
  }

  // ğŸ“Œ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  async function updateStatus(id, status) {
    await fetch("/.netlify/functions/update-application-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, status })
    });

    alert("âœ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
    loadApplications();
  }

  // ğŸ“Œ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©
  function openModal(id) {
    selectedApplication = id;
    document.getElementById("interviewModal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("interviewModal").style.display = "none";
  }

  // ğŸ“Œ Ø­ÙØ¸ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©
  document.getElementById("saveInterviewBtn").addEventListener("click", async () => {
    const date = document.getElementById("interviewDate").value;

    if (!date) {
      alert("âš  ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¹Ø¯");
      return;
    }

    await fetch("/.netlify/functions/update-application-status", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        id: selectedApplication,
        status: "Ù…Ù‚Ø§Ø¨Ù„Ø©",
        interview_date: date
      })
    });

    closeModal();
    alert("âœ” ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©");
    loadApplications();
  });

  // ğŸ”µ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø´Ø±ÙƒØ©
  async function loadCompanyJobs() {
    const res = await fetch(`/.netlify/functions/get-company-jobs?company_id=${user.id}`);
    const jobs = await res.json();

    const list = document.getElementById("companyJobsList");
    list.innerHTML = "";

    if (!jobs.length) {
      list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¸Ø§Ø¦Ù Ù…Ù†Ø´ÙˆØ±Ø©.</p>";
      return;
    }

    jobs.forEach(job => {
      list.innerHTML += `
        <div class="card">
          <strong>${job.job_title}</strong>
          <div>ğŸ“ ${job.location}</div>
          <div>ğŸ’° ${job.salary_range}</div>
          <br>
          <button class="btn-delete" onclick="deleteJob(${job.id})">ğŸ—‘ Ø­Ø°Ù</button>
        </div>
      `;
    });
  }

  // âŒ Ø­Ø°Ù ÙˆØ¸ÙŠÙØ©
  async function deleteJob(job_id) {
    const sure = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©ØŸ");
    if (!sure) return;

    await fetch("/.netlify/functions/delete-job", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ job_id })
    });

    alert("âœ” ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©");
    loadCompanyJobs();
  }

  loadApplications();
  loadCompanyJobs();
</script>

</body>
</html>
