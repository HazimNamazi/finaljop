<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¬ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±ÙƒØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      background: #eef1f5;
      font-family: 'Tajawal';
      margin: 0;
      padding: 0;
    }

    header {
      background: #007bff;
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
    }

    .logout-btn {
      background: #dc3545;
      padding: 8px 15px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      border: none;
    }

    .main-container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    h2 { color:#007bff; margin-top:0; }

    .card {
      background:#fff;
      padding:20px;
      border-radius:10px;
      margin-bottom:15px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      text-align:right;
    }

    .status { font-weight:bold; margin-top:10px; }

    button {
      padding: 10px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:15px;
      margin-left:7px;
      transition:0.3s;
    }

    textarea.message-box {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 12px;
      font-family: Tajawal;
    }

    .msg-btn {
      background:#17a2b8;
      color:white;
      margin-top:8px;
      width:100%;
    }

    .prev-msg {
      background: #e9f7ff;
      border-left: 4px solid #0a84ff;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    .btn-open-cv {
      background:#6c63ff;
      color:white;
      text-decoration: none;
      display:inline-block;
      padding: 8px 14px;
      border-radius:8px;
      font-size:14px;
      margin-top:10px;
    }

    .btn-open-cv:hover {
      transform: scale(1.03);
    }

    .btn-accept { background:#28a745; color:white; }
    .btn-reject { background:#dc3545; color:white; }
    .btn-interview { background:#007bff; color:white; }

    .job-card {
      background:#fff;
      margin-top:10px;
      padding:15px;
      border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    .job-extra {
      font-size: 14px;
      color: #555;
      margin-top: 6px;
    }

    .delete-job-btn {
      background:#dc3545;
      color:white;
      margin-top:10px;
      width:100%;
    }

    .add-job-form input,
    .add-job-form textarea,
    .add-job-form select {
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:8px;
      margin:6px 0;
      font-family:'Tajawal';
    }

    .add-job-form label {
      font-size: 14px;
      display: block;
      margin-top: 8px;
    }

    .add-job-form button {
      width:100%;
      background:#28a745;
      color:white;
    }

    #addJobForm {
      display:none;
      margin-top:10px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0 4px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
  </style>
</head>

<body>

<header>
  <div id="companyName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</div>
  <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</header>

<div class="main-container">

  <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  <div class="container">
    <h2>ğŸ“¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</h2>
    <div id="applicationsList"></div>
  </div>

  <!-- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù -->
  <div class="container">
    <h2>ğŸ’¼ ÙˆØ¸Ø§Ø¦ÙÙƒ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h2>

    <button class="btn-interview" onclick="toggleAddJob()">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ©</button>

    <form id="addJobForm" class="add-job-form">
      <input id="job_title" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
      <input id="location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
      <input id="salary_range" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹">

      <!-- ğŸ”µ Ù‚Ø³Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ© -->
      <label for="job_department">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù„Ù„ÙˆØ¸ÙŠÙØ©:</label>
      <select id="job_department">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
        <option value="Ø§Ù„ØµØ­Ø©">Ø§Ù„ØµØ­Ø©</option>
        <option value="Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³Ø¨">Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³Ø¨</option>
        <option value="Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©">Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©</option>
        <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</option>
      </select>

      <!-- âœ… ØªØ­Ø¯ÙŠØ¯ Ø£Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… -->
      <div class="checkbox-row">
        <input type="checkbox" id="department_restricted">
        <label for="department_restricted">Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ø·Ù„Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
      </div>

      <!-- â° ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© -->
      <label for="interview_time">ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <input type="datetime-local" id="interview_time">

      <!-- â³ Ø¢Ø®Ø± ÙˆÙ‚Øª Ù„Ù„ØªÙ‚Ø¯ÙŠÙ… -->
      <label for="application_deadline">Ø¢Ø®Ø± ÙˆÙ‚Øª Ù„Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙØ© (Deadline):</label>
      <input type="datetime-local" id="application_deadline">

      <textarea id="job_description" placeholder="Ø§Ù„ÙˆØµÙ" rows="4"></textarea>
      <button type="button" onclick="submitJob()">âœ” Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ©</button>
    </form>

    <div id="companyJobsList"></div>
  </div>

</div>

<script>
  const user = JSON.parse(localStorage.getItem("user"));

  if (!user || user.user_type !== "company") {
    alert("âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ´Ø±ÙƒØ©.");
    location.href = "login.html";
  }

  document.getElementById("companyName").innerText = user.full_name;

  function logout() {
    localStorage.removeItem("user");
    location.href = "login.html";
  }

  /*===========================
        ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  ============================*/
  async function loadApplications() {
    const res = await fetch(`/.netlify/functions/get-company-applications?company_id=${user.id}`);
    const apps = await res.json();

    const list = document.getElementById("applicationsList");
    list.innerHTML = "";

    if (!apps.length) {
      list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>";
      return;
    }

    apps.forEach(app => {
      const lastMsg = app.message_from_company
        ? `<div class="prev-msg">ğŸ’¬ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©:<br>${app.message_from_company}</div>`
        : "";

      const cvHtml = app.cv_url
        ? `<a href="${app.cv_url}" class="btn-open-cv" download>ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</a>`
        : "<p style='color:red'>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©</p>";

      list.innerHTML += `
        <div class="card">
          <div><strong>${app.applicant_name}</strong> â€¢ ${app.job_title}</div>
          <div>ğŸ“§ ${app.email}</div>
          <div class="status">Ø§Ù„Ø­Ø§Ù„Ø©: ${app.status}</div>

          ${cvHtml}
          ${lastMsg}

          <textarea id="msg-${app.id}" class="message-box" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø·Ø§Ù„Ø¨..."></textarea>
          <button class="msg-btn" onclick="sendMessage(${app.id})">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„</button>

          <br><br>

          <button class="btn-accept" onclick="updateStatus(${app.id}, 'Ù…Ù‚Ø¨ÙˆÙ„')">Ù‚Ø¨ÙˆÙ„</button>
          <button class="btn-reject" onclick="updateStatus(${app.id}, 'Ù…Ø±ÙÙˆØ¶')">Ø±ÙØ¶</button>
          <button class="btn-interview" onclick="setInterview(${app.id})">ğŸ“… Ù…Ù‚Ø§Ø¨Ù„Ø©</button>
        </div>
      `;
    });
  }

  /*===========================
        Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  ============================*/
  async function sendMessage(application_id) {
    const message = document.getElementById(`msg-${application_id}`).value.trim();

    if (!message) return alert("âš ï¸ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹");

    await fetch("/.netlify/functions/send-message", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ application_id, message })
    });

    alert("âœ”ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
    loadApplications();
  }

  /*===========================
       ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  ============================*/
  async function updateStatus(id, status) {
    await fetch("/.netlify/functions/update-application-status", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ id, status })
    });

    alert("âœ” ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
    loadApplications();
  }

  /*===========================
        Ø§Ù„ÙˆØ¸Ø§Ø¦Ù - Ø¹Ø±Ø¶
  ============================*/
  async function loadCompanyJobs() {
    const res = await fetch(`/.netlify/functions/get-company-jobs?company_id=${user.id}`);
    const jobs = await res.json();

    const box = document.getElementById("companyJobsList");
    box.innerHTML = "";

    if (!jobs.length) {
      box.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ¸Ø§Ø¦Ù.</p>";
      return;
    }

    jobs.forEach(job => {
      const dept = job.department ? `Ø§Ù„Ù‚Ø³Ù…: ${job.department}` : "Ø§Ù„Ù‚Ø³Ù…: Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…";
      const restricted = job.restrict_to_department ? "ğŸ”’ Ø®Ø§ØµØ© Ø¨Ø·Ù„Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙÙ‚Ø·" : "âœ… Ù…ØªØ§Ø­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…";
      const interview = job.interview_time ? `ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©: ${job.interview_time}` : "";
      const deadline = job.application_deadline ? `â³ Ø¢Ø®Ø± ÙˆÙ‚Øª Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…: ${job.application_deadline}` : "";

      box.innerHTML += `
        <div class="job-card">
          <strong>${job.job_title}</strong>
          <div>ğŸ“ ${job.location || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
          <div>ğŸ’° ${job.salary_range || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
          <div class="job-extra">${dept}</div>
          <div class="job-extra">${restricted}</div>
          ${interview ? `<div class="job-extra">${interview}</div>` : ""}
          ${deadline ? `<div class="job-extra">${deadline}</div>` : ""}

          <button class="delete-job-btn" onclick="deleteJob(${job.id})">ğŸ—‘ Ø­Ø°Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©</button>
        </div>
      `;
    });
  }

  /*===========================
        Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ©
  ============================*/
  function toggleAddJob() {
    const form = document.getElementById("addJobForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  async function submitJob() {
    const job_title = document.getElementById("job_title").value.trim();
    const job_description = document.getElementById("job_description").value.trim();
    const location = document.getElementById("location").value.trim();
    const salary_range = document.getElementById("salary_range").value.trim();
    const department = document.getElementById("job_department").value;
    const restrict_to_department = document.getElementById("department_restricted").checked;
    const interview_time = document.getElementById("interview_time").value;
    const application_deadline = document.getElementById("application_deadline").value;

    if (!job_title) {
      alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ");
      return;
    }

    if (!application_deadline) {
      if (!confirm("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø¢Ø®Ø± ÙˆÙ‚Øª Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ¬Ø¹Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ù…ÙØªÙˆØ­Ø© Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
        return;
      }
    }

    const body = {
      company_id: user.id,
      job_title,
      job_description,
      location,
      salary_range,
      department: department || null,
      restrict_to_department,
      interview_time: interview_time || null,
      application_deadline: application_deadline || null
    };

    await fetch("/.netlify/functions/add-job", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    alert("âœ” ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸ÙŠÙØ©");

    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById("job_title").value = "";
    document.getElementById("job_description").value = "";
    document.getElementById("location").value = "";
    document.getElementById("salary_range").value = "";
    document.getElementById("job_department").value = "";
    document.getElementById("department_restricted").checked = false;
    document.getElementById("interview_time").value = "";
    document.getElementById("application_deadline").value = "";

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    // document.getElementById("addJobForm").style.display = "none";

    loadCompanyJobs();
  }

  /*===========================
        Ø­Ø°Ù ÙˆØ¸ÙŠÙØ©
  ============================*/
  async function deleteJob(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;

    await fetch(`/.netlify/functions/delete-job?id=${id}`);
    alert("âœ” ØªÙ… Ø§Ù„Ø­Ø°Ù");
    loadCompanyJobs();
  }

  /* CALL */
  loadApplications();
  loadCompanyJobs();

</script>

</body>
</html>
